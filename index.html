<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice & Work Hours ‚Üí PDF</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --surface:#ffffff; --surface-2:#f9fafb; --line:#e5e7eb;
      --muted:#6b7280; --text:#111827; --brand:#2563eb; --brand-2:#1e40af;
      --ring:rgba(37,99,235,.18); --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 24px}
    h1{font-size:28px;margin:0 0 8px;letter-spacing:.2px;font-weight:700}
    .subtle{color:var(--muted);font-size:13px;margin:0 0 18px}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:18px 18px 16px;margin:18px 0;box-shadow:var(--shadow)}
    .section-title{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:600;letter-spacing:.3px;margin:4px 0 10px;color:#111827}
    .section-title::after{content:"";height:1px;flex:1;background:linear-gradient(90deg,var(--line),transparent);margin-left:6px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .grid-2{grid-column:span 2}.grid-3{grid-column:span 3}.grid-4{grid-column:span 4}.grid-6{grid-column:span 6}.grid-12{grid-column:span 12}
    label{display:block;font-size:11px;letter-spacing:.4px;text-transform:uppercase;color:var(--muted);margin:2px 0 6px}
    input,textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--surface-2);color:var(--text);font-family:inherit;font-size:14px;outline:none;transition:border-color .15s,box-shadow .15s,background .15s;text-align:left}
    textarea{min-height:140px;resize:vertical}
    input::placeholder,textarea::placeholder{color:#9aa3af}
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring);background:#fff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s,background .15s,border-color .15s}
    .btn:hover{transform:translateY(-1px);background:#f3f4f6;border-color:#d1d5db}
    .btn.brand{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:0;color:#fff;font-weight:600;box-shadow:0 8px 18px rgba(37,99,235,.25)}
    .btn.brand:hover{filter:brightness(1.02)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;font-size:14px;border-bottom:1px dashed var(--line)}
    th{color:#374151;font-weight:600;text-align:left}
    td{text-align:left}.right{text-align:right}.subtotal{font-variant-numeric:tabular-nums}
    .totals{max-width:420px;margin-left:auto}
    .totals .rowline{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--line);font-variant-numeric:tabular-nums}
    .totals .rowline:last-child{border-bottom:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff;border:1px solid var(--line);font-size:12px;color:#374151}
    @media (max-width:860px){.row{grid-template-columns:repeat(6,1fr)}.grid-6{grid-column:span 6}.grid-4{grid-column:span 6}.grid-3{grid-column:span 3}.grid-2{grid-column:span 3}}
  </style>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Invoice & Work Hours ‚Üí PDF <span class="pill">client-side</span></h1>
    <p class="subtle">Enter your details, add regular and overtime rows, then click <b>Generate PDF</b> or <b>Download PDF</b>.</p>

    <!-- Top form -->
    <div class="card">
      <div class="row">
        <div class="grid-3"><label>Invoice Number</label><input id="invNumber" placeholder="e.g., 008" /></div>
        <div class="grid-3"><label>Invoice Date (text)</label><input id="invDate" placeholder="e.g., Sep 28 ‚Äì Oct 04, 2025" /></div>
        <div class="grid-3"><label>Tax Label</label><input id="taxLabel" value="HST (13%)" /></div>
        <div class="grid-3"><label>Tax Rate (%)</label><input id="taxRate" type="number" step="0.01" value="13" /></div>

        <div class="grid-6"><label>From (Your business)</label>
          <textarea id="fromBlock" placeholder="Business name:&#10;Street, City, Province:&#10;Email:&#10;Phone:&#10;HST Number:"></textarea>
        </div>
        <div class="grid-6"><label>Bill To (Client)</label>
          <textarea id="toBlock" placeholder="Client name:&#10;Address:&#10;Email:&#10;Phone:"></textarea>
        </div>
      </div>
    </div>

    <!-- Regular Hours -->
    <div class="card" id="regularCard">
      <div class="section-title">Hours Worked</div>
      <table id="regularTable">
        <thead>
          <tr>
            <th>Hours</th><th>Rate/hr</th><th>Expenses</th><th>Description</th><th>Subtotal</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="toolbar">
        <button class="btn" onclick="addRow('regular')">+ Add Row</button>
        <button class="btn" onclick="clearRows('regular')">Clear</button>
      </div>
    </div>

    <!-- Overtime Hours -->
    <div class="card" id="overtimeCard">
      <div class="section-title">Overtime Hours</div>
      <table id="overtimeTable">
        <thead>
          <tr>
            <th>Hours</th><th>Rate/hr</th><th>Subtotal</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="toolbar">
        <button class="btn" onclick="addRow('overtime')">+ Add Row</button>
        <button class="btn" onclick="clearRows('overtime')">Clear</button>
      </div>
    </div>

    <!-- Totals + Notes -->
    <div class="card">
      <div class="row">
        <div class="grid-6">
          <label>Notes (optional)</label>
          <textarea id="notes" placeholder="Payment terms, banking info, thanks, etc."></textarea>
        </div>
        <div class="grid-6"><div class="totals" id="totalsBox"></div></div>
      </div>

      <div class="toolbar">
        <button id="genBtn" type="button" class="btn brand">üßæ Generate PDF</button>
        <button id="downloadBtn" type="button" class="btn">‚¨áÔ∏è Download PDF</button>
        <!-- this link will be filled after Generate for quick re-open if needed -->
        <a id="openLink" class="btn" style="display:none" target="_blank">Open PDF</a>
      </div>
    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const byId = id => document.getElementById(id);
    const money = v => (isFinite(v)? Number(v):0).toFixed(2);

    function addRow(kind){
      const table = byId(kind+"Table").querySelector('tbody');
      const tr = document.createElement('tr');
      if(kind === 'regular'){
        tr.innerHTML = `
          <td class="right"><input type="number" step="0.01" value="0" oninput="recalc()" /></td>
          <td class="right"><input type="number" step="0.01" value="0" oninput="recalc()" /></td>
          <td class="right"><input type="number" step="0.01" value="0" oninput="recalc()" /></td>
          <td><input placeholder="e.g., One Hill Cres" oninput="recalc()" /></td>
          <td class="right subtotal">$0.00</td>
          <td class="right"><button class="btn" onclick="this.closest('tr').remove(); recalc()">‚úï</button></td>`;
      } else {
        tr.innerHTML = `
          <td class="right"><input type="number" step="0.01" value="0" oninput="recalc()" /></td>
          <td class="right"><input type="number" step="0.01" value="0" oninput="recalc()" /></td>
          <td class="right subtotal">$0.00</td>
          <td class="right"><button class="btn" onclick="this.closest('tr').remove(); recalc()">‚úï</button></td>`;
      }
      table.appendChild(tr); recalc();
    }
    function clearRows(kind){ byId(kind+"Table").querySelector('tbody').innerHTML=''; recalc(); }

    function parseTable(kind){
      return [...byId(kind+"Table").querySelectorAll('tbody tr')].map(r=>{
        let hours=0, rate=0, exp=0, desc='';
        const inputs = r.querySelectorAll('input');
        if(kind==='regular'){ hours=+inputs[0].value||0; rate=+inputs[1].value||0; exp=+inputs[2].value||0; desc=r.querySelector('td:nth-child(4) input')?.value?.trim()||''; }
        else { hours=+inputs[0].value||0; rate=+inputs[1].value||0; }
        const subtotal = hours*rate + (kind==='regular'?exp:0);
        const sEl=r.querySelector('.subtotal'); if(sEl) sEl.textContent=`$${money(subtotal)}`;
        return {desc,hours,rate,expenses:(kind==='regular'?exp:0),subtotal};
      });
    }

    function recalc(){
      const regular  = parseTable('regular');
      const overtime = parseTable('overtime');
      const taxRate = (+byId('taxRate').value || 0) / 100;
      const sum = a => a.reduce((x,y)=>x+y,0);

      const regH = sum(regular.map(r=>r.hours));
      const otH  = sum(overtime.map(r=>r.hours));
      const regSub = sum(regular.map(r=>r.subtotal));
      const otSub  = sum(overtime.map(r=>r.subtotal));
      const overallHours    = regH + otH;
      const overallSubtotal = regSub + otSub;

      // tax base: labor only
      const regLabor = sum(regular.map(r=>r.hours * r.rate));
      const otLabor  = sum(overtime.map(r=>r.hours * r.rate));
      const laborBase = regLabor + otLabor;

      const tax = Math.round(laborBase * taxRate * 100) / 100;
      const total = overallSubtotal + tax;

      byId('totalsBox').innerHTML = `
        <div class='rowline'><span>Regular Subtotal</span><span>$${overallSubtotal ? regSub.toFixed(2) : '0.00'}</span></div>
        <div class='rowline'><span>Overtime Subtotal</span><span>$${overallSubtotal ? otSub.toFixed(2) : '0.00'}</span></div>
        <div class='rowline'><span><b>Overall Hours</b></span><span><b>${overallHours.toFixed(2)}</b></span></div>
        <div class='rowline'><span><b>Overall Subtotal</b></span><span><b>$${overallSubtotal.toFixed(2)}</b></span></div>
        <div class='rowline'><span>${byId('taxLabel').value}</span><span>$${tax.toFixed(2)}</span></div>
        <div class='rowline' style='font-size:18px'><span><b>Total Due</b></span><span><b>$${total.toFixed(2)}</b></span></div>
      `;
    }

    // ---------- PDF builder (returns a fresh jsPDF each call) ----------
    function buildPdf(){
      if(!window.jspdf || !window.jspdf.jsPDF) { throw new Error('jsPDF not loaded'); }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      if(typeof doc.autoTable !== 'function') { throw new Error('AutoTable not loaded'); }

      // Always recalc from current DOM values before reading
      recalc();

      const margin = 36, titleSize = 15, gapUnderTitle = 8, gapBetweenSections = 26, gapBeforeTotals = 24, gapAfterTotalsTitle = 10;
      let y = margin;
      const text = (t,x,y,opts={}) => doc.text(t,x,y,opts);

      // Header
      doc.setFontSize(24).setFont(undefined,'bold'); text('INVOICE', margin, y);
      doc.setFontSize(11).setFont(undefined,'normal');
      text(`Invoice #: ${byId('invNumber').value || ''}`, margin, y + 20);
      text(`Date: ${byId('invDate').value || ''}`,     margin, y + 36);
      y += 56;
      doc.setDrawColor(220); doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y); y += 12;

      // From / To
      const from = byId('fromBlock').value.trim();
      const to   = byId('toBlock').value.trim();
      doc.setFont(undefined,'bold'); text('From:', margin, y);
      doc.setFont(undefined,'normal'); doc.text(from || '', margin, y + 16, { maxWidth: 250, align: 'left' });
      doc.setFont(undefined,'bold'); text('Bill To:', margin + 300, y);
      doc.setFont(undefined,'normal'); doc.text(to || '', margin + 300, y + 16, { maxWidth: 250, align: 'left' });
      y += 112; doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y); y += 14;

      const sectionTitle = t => { doc.setFontSize(titleSize).setFont(undefined,'bold'); text(t, margin, y); y += gapUnderTitle; doc.setFontSize(11).setFont(undefined,'normal'); };

      // Hours Worked
      sectionTitle('Hours Worked');
      const reg = parseTable('regular');
      const regRows = reg.map(r => [ r.hours.toFixed(2), `$${money(r.rate)}`, `$${money(r.expenses)}`, r.desc || '‚Äî', `$${money(r.subtotal)}` ]);
      if(!regRows.length) regRows.push(['0.00','$0.00','$0.00','‚Äî','$0.00']);
      doc.autoTable({
        head:[["Hours","Rate/hr","Expenses","Description","Subtotal"]],
        body:regRows,
        startY:y,
        styles:{font:'helvetica', fontSize:10, cellPadding:6},
        headStyles:{fillColor:[240,240,240], textColor:[0,0,0]},
        theme:'grid',
        margin:{left:margin,right:margin}
      });
      y = doc.lastAutoTable.finalY + gapBetweenSections;

      // Overtime Hours
      sectionTitle('Overtime Hours');
      const ot = parseTable('overtime');
      const otRows = ot.map(r => [ r.hours.toFixed(2), `$${money(r.rate)}`, `$${money(r.subtotal)}` ]);
      if(!otRows.length) otRows.push(['0.00','$0.00','$0.00']);
      doc.autoTable({
        head:[["Hours","Rate/hr","Subtotal"]],
        body:otRows,
        startY:y,
        styles:{fontSize:10, cellPadding:6},
        headStyles:{fillColor:[240,240,240], textColor:[0,0,0]},
        theme:'grid',
        margin:{left:margin,right:margin}
      });
      y = doc.lastAutoTable.finalY + gapBeforeTotals;

      // Totals data
      const sum = a => a.reduce((x,y)=>x+y,0);
      const taxLabel = byId('taxLabel').value;
      const taxRate  = (+byId('taxRate').value||0)/100;
      const regSub = sum(reg.map(r=>r.subtotal));
      const otSub  = sum(ot.map(r=>r.subtotal));
      const overallHours = sum(reg.map(r=>r.hours)) + sum(ot.map(r=>r.hours));
      const overallSub   = regSub + otSub;
      const regLabor = sum(reg.map(r=>r.hours * r.rate));
      const otLabor  = sum(ot.map(r=>r.hours * r.rate));
      const tax   = Math.round((regLabor + otLabor) * taxRate * 100) / 100;
      const total = overallSub + tax;

      // Totals title + line
      doc.setLineWidth(0.3); doc.setFontSize(titleSize).setFont(undefined,'bold'); text('Totals', margin, y); y += 6;
      doc.line(margin, y, doc.internal.pageSize.getWidth() - margin, y); y += gapAfterTotalsTitle;

      // Totals table
      const pageW  = doc.internal.pageSize.getWidth();
      const innerW = pageW - margin * 2;
      const amtCol = 120;
      doc.autoTable({
        head: [['Label','Amount']],
        body: [
          ['Regular Subtotal:', `$${overallSub ? regSub.toFixed(2) : '0.00'}`],
          ['Overtime Subtotal:', `$${overallSub ? otSub.toFixed(2) : '0.00'}`],
          ['Overall Hours:',    overallHours.toFixed(2)],
          ['Overall Subtotal:', `$${overallSub.toFixed(2)}`],
          [taxLabel,            `$${tax.toFixed(2)}`],
          ['Total Due:',        `$${total.toFixed(2)}`]
        ],
        startY: y,
        theme: 'plain',
        styles: { fontSize: 10, cellPadding: 6 },
        headStyles: { fillColor: [240,240,240], textColor: [0,0,0] },
        margin: { left: margin, right: margin },
        tableWidth: innerW,
        columnStyles: {
          0: { cellWidth: innerW - amtCol, fontStyle: 'bold' }, // bold labels
          1: { cellWidth: amtCol, halign: 'right' }
        },
        didParseCell: d => { if(d.section === 'head' && d.column.index === 1){ d.cell.styles.halign = 'right'; } }
      });

      // Notes
      const notes = byId('notes').value.trim();
      if(notes){
        const ny = doc.lastAutoTable.finalY + 20;
        doc.setFontSize(12).setFont(undefined,'bold'); doc.text('Notes:', margin, ny);
        doc.setFontSize(10).setFont(undefined,'normal');
        doc.text(notes, margin, ny + 18, { maxWidth: pageW - margin*2 });
      }

      const fname = `Invoice_${(byId('invNumber').value || 'draft').replace(/\s+/g,'')}.pdf`;
      return { doc, fname };
    }

    // ---------- Buttons wiring ----------
    window.addEventListener('DOMContentLoaded', () => {
      addRow('regular'); addRow('overtime'); recalc();

      byId('genBtn').addEventListener('click', () => {
        try{
          const { doc, fname } = buildPdf();
          const blob = doc.output('blob');
          const url = URL.createObjectURL(blob);

          // open in new tab
          window.open(url, '_blank');

          // provide an "Open PDF" link for users who blocked popups
          const openLink = byId('openLink');
          openLink.href = url;
          openLink.style.display = 'inline-flex';
          openLink.textContent = 'Open PDF';
          openLink.download = fname; // optional: lets them long-press to save
        }catch(e){
          alert(e.message || 'Failed to generate PDF.');
          console.error(e);
        }
      });

      // Download: save directly
      byId('downloadBtn').addEventListener('click', () => {
        try{
          const { doc, fname } = buildPdf();
          doc.save(fname);
        }catch(e){
          alert(e.message || 'Failed to download PDF.');
          console.error(e);
        }
      });
    });
  </script>
</body>
</html>
